<!DOCTYPE html>
<html>

<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Todo List">
    
    <title>Todo List Tracker</title>
    
</head>

<body>
    
    <textarea id="textarea" rows="40" id="main"></textarea>
    

    <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
    <script src="https://cdn.rawgit.com/bitwiseshiftleft/sjcl/master/sjcl.js"></script>
    <script src="https://cdn.rawgit.com/alertifyjs/alertify.js/v1.0.10/dist/js/alertify.js"></script>
    <script src="https://cdn.tinymce.com/4/tinymce.min.js"></script>
    
    <script>
        /* global firebase */
        /* global sjcl */
        /* global tinymce */
        /* global alertify */
        
        
        // Initialize Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyDJCb1IQlPbKwe87kayevz0Mri8QVlAKhE",
            authDomain: "todolist-1a1a7.firebaseapp.com",
            databaseURL: "https://todolist-1a1a7.firebaseio.com",
            storageBucket: "",
        });
        
        var ref = firebase.database().ref();
        var password;
        
        
        
        alertify.prompt("Enter your password", function(val, ev) {
                ev.preventDefault();
                password = val;
                
                
                // init data
                ref.child('text').once('value', function(snapshot) {
                    try {
                        editor.setContent(sjcl.decrypt(password, JSON.stringify(JSON.parse(snapshot.val()))));
                    } catch (e) {
                        console.error(e);
                        alert('Wrong password!');
                    }
                });
            }, function(ev) {
                ev.preventDefault();
            }
        );
        
        
        
        // init tinyMCE
        var editor;
        tinymce.init({
            selector: 'textarea',
            toolbar: 'fontselect fontsizeselect | undo redo forecolor backcolor | alignleft aligncenter alignright alignjustify bold italic underline strikethrough | bullist numlist save-button',
            menu: {
                file: {title: 'File', items: 'print'},
                edit: {title: 'Edit', items: 'cut copy paste pastetext | selectall searchreplace'},
                insert: {title: 'Insert', items: 'charmap insertdatetime'},
                format: {title: 'Format', items: ' superscript subscript | formats | removeformat'},
                table: {title: 'Table', items: 'inserttable tableprops deletetable | cell row column'}
            },
            statusbar: false,
            plugins: 'autoresize table insertdatetime charmap textcolor colorpicker print searchreplace',
            autoresize_max_height: window.innerHeight - 90,
            setup: function(editor) {
                editor.addButton('save-button', {
                    text: 'Save',
                    icon: false,
                    onclick: function() {
                        if (password) {
                            ref.set({
                                text: sjcl.encrypt(password, editor.getContent())
                            });
                        }
                    }
                });
            }
        }).then(function(editors) {
            editor = editors[0];
        });
        
        
        
        var alertInput = document.querySelectorAll('.alertify>.dialog>div>input')[0];
        
        // make the input type password
        alertInput.setAttribute('type', 'password');
        
        alertInput.onkeydown = function(e) {
            if (e.keyCode === 13) {
                // click ok button
                document.querySelectorAll('.alertify>.dialog>div>nav>.ok')[0].click();
            }
        };
    </script>
</body>

</html>